name: iOS Build and Test

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:

env:
  DEVELOPMENT_TEAM: '9RWAJP8AG7'
  BUNDLE_IDENTIFIER: 'dev.iori.depthcamera0'
  MARKETING_VERSION: '1.1'

jobs:
  # Build and Test Job
  build-and-test:
    runs-on: macos-latest

    steps:
    - name: Checkout Repository
      uses: actions/checkout@v4

    - name: Setup Xcode
      uses: maxim-lobanov/setup-xcode@v1
      with:
        xcode-version: 'latest-stable'

    - name: Setup Ruby
      uses: ruby/setup-ruby@v1
      with:
        ruby-version: '3.2'
        bundler-cache: true

    - name: Cache CocoaPods
      uses: actions/cache@v3
      with:
        path: |
          Pods
          ~/Library/Caches/CocoaPods
          ~/.cocoapods
        key: ${{ runner.os }}-pods-${{ hashFiles('**/Podfile.lock') }}
        restore-keys: |
          ${{ runner.os }}-pods-

    - name: Install CocoaPods Dependencies
      run: |
        cd DepthCamera
        pod install --repo-update

    - name: Show CocoaPods Versions
      run: |
        cd DepthCamera
        pod --version

    - name: List Available Schemes
      run: |
        cd DepthCamera
        xcodebuild -workspace DepthCamera.xcworkspace -list

    - name: Build for Testing
      run: |
        cd DepthCamera
        xcodebuild \
          -workspace DepthCamera.xcworkspace \
          -scheme DepthCamera \
          -destination 'platform=iOS Simulator,name=iPhone 15 Pro,OS=latest' \
          -configuration Debug \
          -enableCodeCoverage YES \
          build-for-testing

    - name: Run Unit Tests
      run: |
        cd DepthCamera
        xcodebuild test \
          -workspace DepthCamera.xcworkspace \
          -scheme DepthCamera \
          -destination 'platform=iOS Simulator,name=iPhone 15 Pro,OS=latest' \
          -configuration Debug \
          -enableCodeCoverage YES \
          -resultBundlePath TestResults.xcresult

    - name: Run UI Tests
      run: |
        cd DepthCamera
        xcodebuild test \
          -workspace DepthCamera.xcworkspace \
          -scheme DepthCamera \
          -destination 'platform=iOS Simulator,name=iPhone 15 Pro,OS=latest' \
          -configuration Debug \
          -only-testing:DepthCameraUITests \
          -resultBundlePath UITestResults.xcresult

    - name: Generate Code Coverage Report
      run: |
        cd DepthCamera
        xcrun xccov view --report --json TestResults.xcresult > coverage.json

    - name: Upload Test Results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: test-results
        path: |
          DepthCamera/TestResults.xcresult
          DepthCamera/UITestResults.xcresult
          DepthCamera/coverage.json
        retention-days: 30

    - name: Upload Coverage to Codecov
      uses: codecov/codecov-action@v4
      with:
        file: ./DepthCamera/coverage.json
        flags: unittests
        name: codecov-umbrella

  # Archive Build Job
  archive:
    needs: build-and-test
    runs-on: macos-latest
    if: github.ref == 'refs/heads/main' || github.event_name == 'workflow_dispatch'

    steps:
    - name: Checkout Repository
      uses: actions/checkout@v4

    - name: Setup Xcode
      uses: maxim-lobanov/setup-xcode@v1
      with:
        xcode-version: 'latest-stable'

    - name: Setup Ruby
      uses: ruby/setup-ruby@v1
      with:
        ruby-version: '3.2'
        bundler-cache: true

    - name: Cache CocoaPods
      uses: actions/cache@v3
      with:
        path: |
          Pods
          ~/Library/Caches/CocoaPods
          ~/.cocoapods
        key: ${{ runner.os }}-pods-${{ hashFiles('**/Podfile.lock') }}
        restore-keys: |
          ${{ runner.os }}-pods-

    - name: Install CocoaPods Dependencies
      run: |
        cd DepthCamera
        pod install

    - name: Configure Build Number
      run: |
        cd DepthCamera
        BUILD_NUMBER=${{ github.run_number }}
        echo "Build number: $BUILD_NUMBER"
        agvtool new-marketing-version ${{ env.MARKETING_VERSION }}
        agvtool new-version -all $BUILD_NUMBER

    - name: Archive App
      run: |
        cd DepthCamera
        xcodebuild \
          -workspace DepthCamera.xcworkspace \
          -scheme DepthCamera \
          -configuration Release \
          -destination generic/platform=iOS \
          -archivePath $PWD/build/DepthCamera.xcarchive \
          archive \
          CODE_SIGN_STYLE=Manual \
          DEVELOPMENT_TEAM=${{ env.DEVELOPMENT_TEAM }} \
          PROVISIONING_PROFILE_SPECIFIER="" \
          CODE_SIGN_IDENTITY=""

    - name: Export Archive (Development)
      run: |
        cd DepthCamera
        mkdir -p build
        cat > build/ExportOptions.plist << EOF
        <?xml version="1.0" encoding="UTF-8"?>
        <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
        <plist version="1.0">
        <dict>
            <key>method</key>
            <string>development</string>
            <key>teamID</key>
            <string>${{ env.DEVELOPMENT_TEAM }}</string>
            <key>uploadBitcode</key>
            <false/>
            <key>uploadSymbols</key>
            <true/>
            <key>compileBitcode</key>
            <false/>
            <key>signingStyle</key>
            <string>manual</string>
            <key>signingCertificate</key>
            <string>iPhone Developer</string>
        </dict>
        </plist>
        EOF

        xcodebuild \
          -exportArchive \
          -archivePath $PWD/build/DepthCamera.xcarchive \
          -exportPath $PWD/build/DepthCamera-dev \
          -exportOptionsPlist build/ExportOptions.plist

    - name: Upload Archive
      uses: actions/upload-artifact@v4
      with:
        name: depthcamera-archive
        path: |
          DepthCamera/build/DepthCamera.xcarchive
          DepthCamera/build/DepthCamera-dev
        retention-days: 30

  # Security Analysis Job
  security-scan:
    runs-on: macos-latest
    if: github.event_name == 'pull_request'

    steps:
    - name: Checkout Repository
      uses: actions/checkout@v4

    - name: Run SwiftLint
      run: |
        # Install SwiftLint if not present
        if ! command -v swiftlint &> /dev/null; then
          brew install swiftlint
        fi
        cd DepthCamera
        swiftlint lint --strict
      continue-on-error: true

    - name: Security Scan with MobSF
      run: |
        # This would require MobSF setup - placeholder for security scanning
        echo "Security scanning placeholder - would integrate with MobSF or similar tool"

  # Dependency Check Job
  dependency-check:
    runs-on: macos-latest

    steps:
    - name: Checkout Repository
      uses: actions/checkout@v4

    - name: Check CocoaPods Dependencies
      run: |
        cd DepthCamera
        pod outdated || true

    - name: Audit Dependencies for Security
      run: |
        cd DepthCamera
        # Check for any known vulnerable dependencies
        echo "Auditing CocoaPods dependencies..."
        grep -A 10 -B 2 "tiff-ios" Podfile.lock || true