name: Build Unsigned IPA for TrollStore (Fixed)

on:
  push:
    branches: [ main, develop, trollstore ]
  pull_request:
    branches: [ main, develop, trollstore ]
  workflow_dispatch:
    inputs:
      build_type:
        description: 'Build type'
        required: true
        default: 'Release'
        type: choice
        options:
        - Debug
        - Release

env:
  BUNDLE_IDENTIFIER: 'dev.iori.depthcamera0'
  MARKETING_VERSION: '1.1'
  SCHEME_NAME: 'DepthCamera'
  WORKSPACE_NAME: 'DepthCamera.xcworkspace'
  PROJECT_NAME: 'DepthCamera.xcodeproj'
  TROLLSTORE_ENTITLEMENTS: 'DepthCamera/DepthCamera-TrollStore.entitlements'

jobs:
  # Build Unsigned IPA for TrollStore
  build-trollstore:
    runs-on: macos-latest

    steps:
    - name: Checkout Repository
      uses: actions/checkout@v4

    - name: Setup Xcode
      uses: maxim-lobanov/setup-xcode@v1
      with:
        xcode-version: 'latest-stable'

    - name: Setup Ruby
      uses: ruby/setup-ruby@v1
      with:
        ruby-version: '3.2'
        bundler-cache: true

    - name: Cache CocoaPods
      uses: actions/cache@v3
      with:
        path: |
          Pods
          ~/Library/Caches/CocoaPods
          ~/.cocoapods
        key: ${{ runner.os }}-pods-${{ hashFiles('**/Podfile.lock') }}
        restore-keys: |
          ${{ runner.os }}-pods-

    - name: Install CocoaPods Dependencies
      run: |
        pod install --repo-update

    - name: Verify Project Structure
      run: |
        echo "Project root contents:"
        ls -la
        echo ""
        echo "DepthCamera directory:"
        ls -la DepthCamera/
        echo ""
        echo "Looking for workspace:"
        find . -name "*.xcworkspace" -type d
        echo ""
        echo "Looking for TrollStore entitlements:"
        find . -name "*TrollStore*" -type f

    - name: Check TrollStore Entitlements
      run: |
        if [ -f "${{ env.TROLLSTORE_ENTITLEMENTS }}" ]; then
          echo "✅ TrollStore entitlements found at ${{ env.TROLLSTORE_ENTITLEMENTS }}"
          echo "Entitlements contents:"
          head -20 "${{ env.TROLLSTORE_ENTITLEMENTS }}"
        else
          echo "❌ TrollStore entitlements not found at ${{ env.TROLLSTORE_ENTITLEMENTS }}"
          echo "Searching for entitlements files:"
          find . -name "*.entitlements" -type f
          exit 1
        fi

    - name: List Available Schemes
      run: |
        if [ -f "${{ env.WORKSPACE_NAME }}" ]; then
          echo "Schemes in workspace:"
          xcodebuild -workspace ${{ env.WORKSPACE_NAME }} -list
        elif [ -f "${{ env.PROJECT_NAME }}" ]; then
          echo "Schemes in project:"
          xcodebuild -project ${{ env.PROJECT_NAME }} -list
        else
          echo "❌ No Xcode project or workspace found"
          exit 1
        fi

    - name: Configure Build Number
      run: |
        BUILD_NUMBER=${{ github.run_number }}
        echo "Setting build number to: $BUILD_NUMBER"

        # Try to set build number if project exists
        if [ -f "${{ env.PROJECT_NAME }}" ]; then
          cd $(basename "${{ env.PROJECT_NAME }}" .xcodeproj)
          agvtool new-marketing-version ${{ env.MARKETING_VERSION }} || echo "Failed to set marketing version"
          agvtool new-version -all $BUILD_NUMBER || echo "Failed to set build version"
          cd ..
        fi

    - name: Build App without Code Signing
      run: |
        # Configuration based on input
        BUILD_CONFIGURATION="${{ github.event.inputs.build_type || 'Release' }}"
        echo "Building configuration: $BUILD_CONFIGURATION"

        # Create build directory
        mkdir -p build

        # Determine whether to use workspace or project
        if [ -f "${{ env.WORKSPACE_NAME }}" ]; then
          echo "Using workspace: ${{ env.WORKSPACE_NAME }}"
          BUILD_CMD="xcodebuild -workspace ${{ env.WORKSPACE_NAME }}"
        elif [ -f "${{ env.PROJECT_NAME }}" ]; then
          echo "Using project: ${{ env.PROJECT_NAME }}"
          BUILD_CMD="xcodebuild -project ${{ env.PROJECT_NAME }}"
        else
          echo "❌ No Xcode project or workspace found"
          exit 1
        fi

        # Build the app without code signing for TrollStore
        $BUILD_CMD \
          -scheme ${{ env.SCHEME_NAME }} \
          -configuration $BUILD_CONFIGURATION \
          -destination generic/platform=iOS \
          -archivePath build/DepthCamera-TrollStore.xcarchive \
          archive \
          CODE_SIGN_IDENTITY="" \
          CODE_SIGNING_REQUIRED=NO \
          CODE_SIGNING_ALLOWED=NO \
          DEVELOPMENT_TEAM="" \
          PROVISIONING_PROFILE_SPECIFIER="" \
          ENTITLEMENTS_FILE="${{ env.TROLLSTORE_ENTITLEMENTS }}" \
          OTHER_CODE_SIGN_FLAGS="--keychain /dev/null" || {
            echo "❌ Build failed, trying without entitlements..."

            # Retry without entitlements if they cause issues
            $BUILD_CMD \
              -scheme ${{ env.SCHEME_NAME }} \
              -configuration $BUILD_CONFIGURATION \
              -destination generic/platform=iOS \
              -archivePath build/DepthCamera-TrollStore.xcarchive \
              archive \
              CODE_SIGN_IDENTITY="" \
              CODE_SIGNING_REQUIRED=NO \
              CODE_SIGNING_ALLOWED=NO \
              DEVELOPMENT_TEAM="" \
              PROVISIONING_PROFILE_SPECIFIER=""
          }

    - name: Export Unsigned IPA
      run: |
        # Create export options for unsigned IPA
        cat > build/TrollStore-Export.plist << 'EOF'
        <?xml version="1.0" encoding="UTF-8"?>
        <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
        <plist version="1.0">
        <dict>
            <key>method</key>
            <string>development</string>
            <key>signingStyle</key>
            <string>manual</string>
            <key>codeSignIdentity</key>
            <string></string>
            <key>provisioningProfiles</key>
            <dict>
            </dict>
            <key>stripSwiftSymbols</key>
            <false/>
            <key>uploadBitcode</key>
            <false/>
            <key>uploadSymbols</key>
            <false/>
            <key>compileBitcode</key>
            <false/>
            <key>thinning</key>
            <string>&lt;none&gt;</string>
        </dict>
        </plist>
        EOF

        # Export the archive as unsigned IPA
        xcodebuild \
          -exportArchive \
          -archivePath build/DepthCamera-TrollStore.xcarchive \
          -exportPath build/TrollStore-IPA \
          -exportOptionsPlist build/TrollStore-Export.plist \
          -allowProvisioningUpdates || {
            echo "⚠️ Export failed, creating manual IPA..."

            # Create IPA manually if export fails
            echo "Creating IPA manually from archive..."
            cd build

            # Find the .app file
            APP_PATH=$(find DepthCamera-TrollStore.xcarchive -name "*.app" -type d | head -n 1)

            if [ -n "$APP_PATH" ]; then
              echo "Found app at: $APP_PATH"

              # Create Payload directory
              mkdir -p Payload
              cp -r "$APP_PATH" Payload/

              # Create IPA
              zip -r "../DepthCamera-TrollStore-${{ github.run_number }}.ipa" Payload/

              # Clean up
              rm -rf Payload

              echo "✅ Manual IPA created successfully!"
            else
              echo "❌ Could not find .app file in archive"
              exit 1
            fi

            cd ..
          }

    - name: Create Unsigned IPA Package
      run: |
        cd build

        # Find existing IPA or create from export
        if [ -f "TrollStore-IPA/*.ipa" ]; then
          echo "Found exported IPA"
          cp TrollStore-IPA/*.ipa "../DepthCamera-TrollStore-${{ github.run_number }}.ipa"
        elif [ -f "../DepthCamera-TrollStore-${{ github.run_number }}.ipa" ]; then
          echo "IPA already created manually"
        else
          echo "❌ No IPA found, creating from app bundle..."

          # Find the .app file
          APP_PATH=$(find . -name "*.app" -type d | head -n 1)

          if [ -n "$APP_PATH" ]; then
            # Create Payload directory
            mkdir -p Payload
            cp -r "$APP_PATH" Payload/

            # Create IPA
            zip -r "../DepthCamera-TrollStore-${{ github.run_number }}.ipa" Payload/

            # Clean up
            rm -rf Payload
          else
            echo "❌ Could not find .app file"
            exit 1
          fi
        fi

    - name: Verify IPA Structure
      run: |
        if [ -f "DepthCamera-TrollStore-${{ github.run_number }}.ipa" ]; then
          echo "✅ IPA file created successfully!"
          echo "File size: $(du -h DepthCamera-TrollStore-${{ github.run_number }}.ipa)"

          # Extract and verify IPA contents
          mkdir -p temp_verify
          cd temp_verify
          unzip -q "../DepthCamera-TrollStore-${{ github.run_number }}.ipa"

          echo "IPA Contents:"
          find Payload -name "*.app" -exec ls -la {} \;

          cd ..
          rm -rf temp_verify
        else
          echo "❌ IPA file not found!"
          exit 1
        fi

    - name: Generate Build Information
      run: |
        cat > build-info.json << EOF
        {
          "build_number": "${{ github.run_number }}",
          "commit_sha": "${{ github.sha }}",
          "branch": "${{ github.ref_name }}",
          "build_type": "${{ github.event.inputs.build_type || 'Release' }}",
          "timestamp": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
          "bundle_identifier": "${{ env.BUNDLE_IDENTIFIER }}",
          "marketing_version": "${{ env.MARKETING_VERSION }}",
          "ipa_file": "DepthCamera-TrollStore-${{ github.run_number }}.ipa",
          "trollstore_optimized": true
        }
        EOF

        echo "Build information:"
        cat build-info.json

    - name: Upload Unsigned IPA
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: depthcamera-trollstore-ipa
        path: |
          DepthCamera-TrollStore-${{ github.run_number }}.ipa
          build-info.json
        retention-days: 30

    - name: Upload Build Logs
      uses: actions/upload-artifact@v4
      if: failure()
      with:
        name: build-logs
        path: |
          build/
          *.log
        retention-days: 7

  # Build Validation
  validate-build:
    runs-on: macos-latest
    needs: build-trollstore
    if: always() && needs.build-trollstore.result == 'success'

    steps:
    - name: Download IPA
      uses: actions/download-artifact@v4
      with:
        name: depthcamera-trollstore-ipa
        path: ./artifacts

    - name: Validate IPA Structure
      run: |
        cd artifacts
        IPA_FILE=$(find . -name "*.ipa" | head -n 1)

        if [ -n "$IPA_FILE" ]; then
          echo "✅ Validating IPA: $IPA_FILE"

          # Extract IPA
          unzip -q "$IPA_FILE" -d extracted

          # Check app structure
          APP_PATH=$(find extracted/Payload -name "*.app" -type d | head -n 1)

          if [ -n "$APP_PATH" ]; then
            echo "✅ App bundle found: $(basename $APP_PATH)"

            # Check for required files
            if [ -f "$APP_PATH/Info.plist" ]; then
              echo "✅ Info.plist found"
              echo "Bundle ID: $(/usr/libexec/PlistBuddy -c "Print CFBundleIdentifier" "$APP_PATH/Info.plist" 2>/dev/null || echo 'Not found')"
              echo "Version: $(/usr/libexec/PlistBuddy -c "Print CFBundleShortVersionString" "$APP_PATH/Info.plist" 2>/dev/null || echo 'Not found')"
            else
              echo "⚠️ Info.plist not found"
            fi

          else
            echo "❌ No app bundle found in IPA"
            exit 1
          fi
        else
          echo "❌ No IPA file found"
          exit 1
        fi