name: sideload ipa build

on:
  push:
    branches: [ main, develop ]
    tags: [ 'v*' ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:
    inputs:
      build_type:
        description: 'Build type'
        required: true
        default: 'Release'
        type: choice
        options:
        - Debug
        - Release

env:
  BUNDLE_IDENTIFIER: 'dev.iori.depthcamera0'
  MARKETING_VERSION: '1.1'
  SCHEME_NAME: 'DepthCamera'
  PROJECT_DIR: 'lidar-depth-map-capture-for-ios'
  WORKSPACE_NAME: 'DepthCamera.xcworkspace'
  PROJECT_NAME: 'DepthCamera.xcodeproj'

jobs:
  # Build Normal Sideload IPA
  build-sideload:
    runs-on: macos-latest

    steps:
    - name: Checkout Repository
      uses: actions/checkout@v4

    - name: Setup Xcode
      uses: maxim-lobanov/setup-xcode@v1
      with:
        xcode-version: 'latest-stable'

    - name: Setup Ruby
      uses: ruby/setup-ruby@v1
      with:
        ruby-version: '3.2'
        bundler-cache: true

    - name: Cache CocoaPods
      uses: actions/cache@v3
      with:
        path: |
          Pods
          ~/Library/Caches/CocoaPods
          ~/.cocoapods
        key: ${{ runner.os }}-pods-${{ hashFiles('**/Podfile.lock') }}
        restore-keys: |
          ${{ runner.os }}-pods-

    - name: Install CocoaPods Dependencies
      run: |
        echo "ðŸ”§ Installing CocoaPods dependencies in ${{ env.PROJECT_DIR }}..."
        cd ${{ env.PROJECT_DIR }}
        pod install --repo-update
        echo "âœ… CocoaPods installed successfully"

    - name: Verify Project Structure
      run: |
        echo "ðŸ” Verifying project structure..."
        echo "Current directory: $(pwd)"
        echo ""
        echo "Project directory (${{ env.PROJECT_DIR }}) contents:"
        ls -la ${{ env.PROJECT_DIR }}/
        echo ""
        echo "Looking for workspace:"
        find ${{ env.PROJECT_DIR }} -name "*.xcworkspace" -type d
        echo ""
        echo "Looking for project:"
        find ${{ env.PROJECT_DIR }} -name "*.xcodeproj" -type d

    - name: List Available Schemes
      run: |
        cd ${{ env.PROJECT_DIR }}
        echo "ðŸ“‹ Listing available schemes..."
        if [ -f "DepthCamera.xcworkspace" ]; then
          echo "âœ… Using workspace: DepthCamera.xcworkspace"
          xcodebuild -workspace DepthCamera.xcworkspace -list
        elif [ -f "DepthCamera.xcodeproj" ]; then
          echo "âœ… Using project: DepthCamera.xcodeproj"
          xcodebuild -project DepthCamera.xcodeproj -list
        else
          echo "âŒ No Xcode project or workspace found in ${{ env.PROJECT_DIR }}"
          exit 1
        fi

    - name: Configure Build Number
      run: |
        BUILD_NUMBER=${{ github.run_number }}
        echo "ðŸ”¢ Setting build number to: $BUILD_NUMBER"

        # Try to set build number if project exists
        if [ -f "${{ env.PROJECT_NAME }}" ]; then
          echo "Setting version info in ${{ env.PROJECT_NAME }}..."
          cd ${{ env.PROJECT_NAME }} 2>/dev/null || cd $(basename "${{ env.PROJECT_NAME }}" .xcodeproj)
          agvtool new-marketing-version ${{ env.MARKETING_VERSION }} || echo "Failed to set marketing version (non-critical)"
          agvtool new-version -all $BUILD_NUMBER || echo "Failed to set build version (non-critical)"
          cd ..
          echo "âœ… Build number configured"
        else
          echo "âš ï¸ Project not found: ${{ env.PROJECT_NAME }}"
        fi

    - name: Build App for Sideload
      run: |
        # Configuration based on input
        BUILD_CONFIGURATION="${{ github.event.inputs.build_type || 'Release' }}"
        echo "ðŸ”¨ Building configuration: $BUILD_CONFIGURATION"

        # Change to project directory
        cd ${{ env.PROJECT_DIR }}

        # Create build directory in root
        mkdir -p build

        # Determine whether to use workspace or project
        if [ -f "${{ env.WORKSPACE_NAME }}" ]; then
          echo "ðŸ“± Using workspace: ${{ env.WORKSPACE_NAME }}"
          BUILD_CMD="xcodebuild -workspace ${{ env.WORKSPACE_NAME }}"
        elif [ -f "${{ env.PROJECT_NAME }}" ]; then
          echo "ðŸ“± Using project: ${{ env.PROJECT_NAME }}"
          BUILD_CMD="xcodebuild -project ${{ env.PROJECT_NAME }}"
        else
          echo "âŒ No Xcode project or workspace found"
          echo "Available files:"
          ls -la
          echo ""
          echo "Looking for files:"
          find . -name "*.xcworkspace" -type d
          find . -name "*.xcodeproj" -type d
          exit 1
        fi

        echo "ðŸš€ Starting normal sideload build..."

        # Build the app with standard code signing (will create ad-hoc IPA)
        $BUILD_CMD \
          -scheme ${{ env.SCHEME_NAME }} \
          -configuration $BUILD_CONFIGURATION \
          -destination generic/platform=iOS \
          -archivePath build/DepthCamera-Sideload.xcarchive \
          archive \
          CODE_SIGN_IDENTITY="" \
          CODE_SIGNING_REQUIRED=NO \
          CODE_SIGNING_ALLOWED=NO \
          DEVELOPMENT_TEAM="" \
          PROVISIONING_PROFILE_SPECIFIER="" \
          ARCHS=arm64 \
          ONLY_ACTIVE_ARCH=NO

        echo "âœ… Build completed successfully"

    - name: Export Ad-Hoc IPA
      run: |
        echo "ðŸ“¦ Exporting ad-hoc IPA for sideloading..."

        # Create export options for ad-hoc IPA
        cat > build/Sideload-Export.plist << 'EOF'
        <?xml version="1.0" encoding="UTF-8"?>
        <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
        <plist version="1.0">
        <dict>
            <key>method</key>
            <string>ad-hoc</string>
            <key>signingStyle</key>
            <string>manual</string>
            <key>codeSignIdentity</key>
            <string></string>
            <key>provisioningProfiles</key>
            <dict>
            </dict>
            <key>stripSwiftSymbols</key>
            <true/>
            <key>uploadBitcode</key>
            <false/>
            <key>uploadSymbols</key>
            <false/>
            <key>compileBitcode</key>
            <false/>
            <key>thinning</key>
            <string>&lt;none&gt;</string>
        </dict>
        </plist>
        EOF

        # Export the archive as ad-hoc IPA
        xcodebuild \
          -exportArchive \
          -archivePath build/DepthCamera-Sideload.xcarchive \
          -exportPath build/Sideload-IPA \
          -exportOptionsPlist build/Sideload-Export.plist \
          -allowProvisioningUpdates || {
            echo "âš ï¸ Export failed, creating manual IPA..."

            # Create IPA manually if export fails
            echo "ðŸ”§ Creating IPA manually from archive..."
            cd build

            # Find the .app file
            APP_PATH=$(find DepthCamera-Sideload.xcarchive -name "*.app" -type d | head -n 1)

            if [ -n "$APP_PATH" ]; then
              echo "âœ… Found app at: $APP_PATH"
              echo "App size: $(du -sh "$APP_PATH")"

              # Create Payload directory
              mkdir -p Payload
              cp -r "$APP_PATH" Payload/

              # Create IPA
              zip -r "../DepthCamera-Sideload-${{ github.run_number }}.ipa" Payload/

              # Clean up
              rm -rf Payload

              echo "âœ… Manual IPA created successfully!"
            else
              echo "âŒ Could not find .app file in archive"
              exit 1
            fi

            cd ..
          }

        echo "âœ… Export process completed"

    - name: Create Unsigned IPA Package
      run: |
        cd build

        # Find existing IPA or create from export
        if [ -f "Sideload-IPA/*.ipa" ]; then
          echo "ðŸ“± Found exported IPA"
          cp Sideload-IPA/*.ipa "../DepthCamera-Sideload-${{ github.run_number }}.ipa"
        elif [ -f "../DepthCamera-Sideload-${{ github.run_number }}.ipa" ]; then
          echo "ðŸ“± IPA already created manually"
        else
          echo "âš ï¸ No IPA found, creating from app bundle..."

          # Find the .app file
          APP_PATH=$(find . -name "*.app" -type d | head -n 1)

          if [ -n "$APP_PATH" ]; then
            # Create Payload directory
            mkdir -p Payload
            cp -r "$APP_PATH" Payload/

            # Create IPA
            zip -r "../DepthCamera-Sideload-${{ github.run_number }}.ipa" Payload/

            # Clean up
            rm -rf Payload
          else
            echo "âŒ Could not find .app file"
            exit 1
          fi
        fi

        cd ..

    - name: Verify IPA Structure
      run: |
        if [ -f "DepthCamera-Sideload-${{ github.run_number }}.ipa" ]; then
          echo "âœ… IPA file created successfully!"
          echo "ðŸ“Š File size: $(du -h DepthCamera-Sideload-${{ github.run_number }}.ipa)"

          # Extract and verify IPA contents
          mkdir -p temp_verify
          cd temp_verify
          unzip -q "../DepthCamera-Sideload-${{ github.run_number }}.ipa"

          echo "ðŸ“ IPA Contents:"
          find Payload -name "*.app" -exec ls -la {} \;

          APP_NAME=$(find Payload -name "*.app" -type d -exec basename {} \;)
          if [ -n "$APP_NAME" ]; then
            echo "âœ… App bundle verified: $APP_NAME"
          fi

          cd ..
          rm -rf temp_verify
        else
          echo "âŒ IPA file not found!"
          exit 1
        fi

    - name: Generate Build Information
      run: |
        cat > build-info.json << EOF
        {
          "build_number": "${{ github.run_number }}",
          "commit_sha": "${{ github.sha }}",
          "branch": "${{ github.ref_name }}",
          "build_type": "${{ github.event.inputs.build_type || 'Release' }}",
          "timestamp": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
          "bundle_identifier": "${{ env.BUNDLE_IDENTIFIER }}",
          "marketing_version": "${{ env.MARKETING_VERSION }}",
          "ipa_file": "DepthCamera-Sideload-${{ github.run_number }}.ipa",
          "sideload_type": "standard",
          "limitations": [
            "Standard sandbox restrictions",
            "Limited file system access",
            "App Store entitlements only",
            "No enhanced system access"
          ],
          "build_status": "success"
        }
        EOF

        echo "ðŸ“‹ Build information:"
        cat build-info.json

    - name: Upload Sideload IPA
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: depthcamera-sideload-ipa
        path: |
          DepthCamera-Sideload-${{ github.run_number }}.ipa
          build-info.json
        retention-days: 30

    - name: Create Release (Tagged Builds Only)
      if: startsWith(github.ref, 'refs/tags/')
      uses: softprops/action-gh-release@v2
      with:
        name: "DepthCamera Sideload ${{ github.ref_name }}"
        body: |
          ## ðŸ“± DepthCamera Normal Sideload Build

          **Build Information:**
          - ðŸ·ï¸ **Version:** ${{ env.MARKETING_VERSION }} (${{ github.run_number }})
          - ðŸ“… **Date:** $(date +'%Y-%m-%d %H:%M UTC')
          - ðŸ”— **Commit:** [${{ github.sha }}](${{ github.server_url }}/${{ github.repository }}/commit/${{ github.sha }})

          **Features:**
          - âœ… **Standard Sideload** - Compatible with AltStore, Sideloadly, etc.
          - âœ… **Ad-Hoc IPA** - Ready for sideloading tools
          - âœ… **Basic LiDAR** - Standard depth capture capabilities
          - âœ… **App Store Limits** - Standard iOS restrictions

          **Installation:**
          1. Download the `.ipa` file below
          2. Install with your preferred sideload tool (AltStore, Sideloadly, etc.)
          3. Sign with your Apple ID if required

          **Limitations:**
          - âš ï¸ **Standard sandbox** - Limited file system access
          - âš ï¸ **Basic entitlements** - No enhanced system access
          - âš ï¸ **Standard ARKit** - Normal depth capture restrictions

          ---
          ðŸ”„ **Need enhanced features?** Use the TrollStore build for maximum capabilities!
        files: |
          DepthCamera-Sideload-${{ github.run_number }}.ipa
          build-info.json
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}