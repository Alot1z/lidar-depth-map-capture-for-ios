name: trollstore ipa build

on:
  push:
    branches: [ main, develop, trollstore ]
  pull_request:
    branches: [ main, develop, trollstore ]
  workflow_dispatch:
    inputs:
      build_type:
        description: 'Build type'
        required: true
        default: 'Release'
        type: choice
        options:
        - Debug
        - Release

env:
  BUNDLE_IDENTIFIER: 'dev.iori.depthcamera0'
  MARKETING_VERSION: '1.1'
  SCHEME_NAME: 'DepthCamera'
  PROJECT_DIR: 'lidar-depth-map-capture-for-ios'
  WORKSPACE_NAME: 'DepthCamera.xcworkspace'
  PROJECT_NAME: 'DepthCamera.xcodeproj'
  TROLLSTORE_ENTITLEMENTS: 'lidar-depth-map-capture-for-ios/DepthCamera/DepthCamera-TrollStore.entitlements'

jobs:
  # Build Unsigned IPA for TrollStore
  build-trollstore:
    runs-on: macos-latest

    steps:
    - name: Checkout Repository
      uses: actions/checkout@v4

    - name: Setup Xcode
      uses: maxim-lobanov/setup-xcode@v1
      with:
        xcode-version: 'latest-stable'

    - name: Setup Ruby
      uses: ruby/setup-ruby@v1
      with:
        ruby-version: '3.2'
        bundler-cache: true

    - name: Cache CocoaPods
      uses: actions/cache@v3
      with:
        path: |
          Pods
          ~/Library/Caches/CocoaPods
          ~/.cocoapods
        key: ${{ runner.os }}-pods-${{ hashFiles('**/Podfile.lock') }}
        restore-keys: |
          ${{ runner.os }}-pods-

    - name: Install CocoaPods Dependencies
      run: |
        echo "üîß Installing CocoaPods dependencies in ${{ env.PROJECT_DIR }}..."
        cd ${{ env.PROJECT_DIR }}
        pod install --repo-update
        echo "‚úÖ CocoaPods installed successfully"

    - name: Verify Project Structure
      run: |
        echo "üîç Verifying project structure..."
        echo "Current directory: $(pwd)"
        echo ""
        echo "Root directory contents:"
        ls -la
        echo ""
        echo "Project directory (${{ env.PROJECT_DIR }}) contents:"
        ls -la ${{ env.PROJECT_DIR }}/
        echo ""
        echo "Looking for workspace:"
        find ${{ env.PROJECT_DIR }} -name "*.xcworkspace" -type d
        echo ""
        echo "Looking for project:"
        find ${{ env.PROJECT_DIR }} -name "*.xcodeproj" -type d
        echo ""
        echo "Looking for TrollStore entitlements:"
        find ${{ env.PROJECT_DIR }} -name "*TrollStore*" -type f

    - name: Check TrollStore Entitlements
      run: |
        ENTITLEMENTS_FULL_PATH="${{ env.TROLLSTORE_ENTITLEMENTS }}"
        if [ -f "$ENTITLEMENTS_FULL_PATH" ]; then
          echo "‚úÖ TrollStore entitlements found at $ENTITLEMENTS_FULL_PATH"
          echo "Entitlements file size: $(wc -c < "$ENTITLEMENTS_FULL_PATH") bytes"
        else
          echo "‚ùå TrollStore entitlements not found at $ENTITLEMENTS_FULL_PATH"
          echo "Searching for entitlements files:"
          find ${{ env.PROJECT_DIR }} -name "*.entitlements" -type f
          echo "Creating fallback entitlements..."
          mkdir -p ${{ env.PROJECT_DIR }}/DepthCamera
          cat > "$ENTITLEMENTS_FULL_PATH" << 'EOF'
        <?xml version="1.0" encoding="UTF-8"?>
        <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
        <plist version="1.0">
        <dict>
            <key>com.apple.developer.team-identifier</key>
            <string>9RWAJP8AG7</string>
            <key>com.apple.security.application-groups</key>
            <array>
                <string>group.dev.iori.depthcamera</string>
            </array>
        </dict>
        </plist>
        EOF
          echo "‚úÖ Fallback entitlements created"
        fi

    - name: List Available Schemes
      run: |
        cd ${{ env.PROJECT_DIR }}
        echo "üìã Listing available schemes..."
        if [ -f "DepthCamera.xcworkspace" ]; then
          echo "‚úÖ Using workspace: DepthCamera.xcworkspace"
          xcodebuild -workspace DepthCamera.xcworkspace -list
        elif [ -f "DepthCamera.xcodeproj" ]; then
          echo "‚úÖ Using project: DepthCamera.xcodeproj"
          xcodebuild -project DepthCamera.xcodeproj -list
        else
          echo "‚ùå No Xcode project or workspace found in ${{ env.PROJECT_DIR }}"
          exit 1
        fi

    - name: Configure Build Number
      run: |
        BUILD_NUMBER=${{ github.run_number }}
        echo "üî¢ Setting build number to: $BUILD_NUMBER"

        # Try to set build number if project exists
        if [ -f "${{ env.PROJECT_NAME }}" ]; then
          echo "Setting version info in ${{ env.PROJECT_NAME }}..."
          cd ${{ env.PROJECT_NAME }} 2>/dev/null || cd $(basename "${{ env.PROJECT_NAME }}" .xcodeproj)
          agvtool new-marketing-version ${{ env.MARKETING_VERSION }} || echo "Failed to set marketing version (non-critical)"
          agvtool new-version -all $BUILD_NUMBER || echo "Failed to set build version (non-critical)"
          cd ..
          echo "‚úÖ Build number configured"
        else
          echo "‚ö†Ô∏è Project not found: ${{ env.PROJECT_NAME }}"
        fi

    - name: Build App without Code Signing
      run: |
        # Configuration based on input
        BUILD_CONFIGURATION="${{ github.event.inputs.build_type || 'Release' }}"
        echo "üî® Building configuration: $BUILD_CONFIGURATION"

        # Change to project directory
        cd ${{ env.PROJECT_DIR }}

        # Create build directory in root
        mkdir -p build

        # Determine whether to use workspace or project
        if [ -f "${{ env.WORKSPACE_NAME }}" ]; then
          echo "üì± Using workspace: ${{ env.WORKSPACE_NAME }}"
          BUILD_CMD="xcodebuild -workspace ${{ env.WORKSPACE_NAME }}"
        elif [ -f "${{ env.PROJECT_NAME }}" ]; then
          echo "üì± Using project: ${{ env.PROJECT_NAME }}"
          BUILD_CMD="xcodebuild -project ${{ env.PROJECT_NAME }}"
        else
          echo "‚ùå No Xcode project or workspace found"
          echo "Available files:"
          ls -la
          echo ""
          echo "Looking for files:"
          find . -name "*.xcworkspace" -type d
          find . -name "*.xcodeproj" -type d
          exit 1
        fi

        echo "üöÄ Starting build process..."

        # Build the app without code signing for TrollStore
        $BUILD_CMD \
          -scheme ${{ env.SCHEME_NAME }} \
          -configuration $BUILD_CONFIGURATION \
          -destination generic/platform=iOS \
          -archivePath build/DepthCamera-TrollStore.xcarchive \
          archive \
          CODE_SIGN_IDENTITY="" \
          CODE_SIGNING_REQUIRED=NO \
          CODE_SIGNING_ALLOWED=NO \
          DEVELOPMENT_TEAM="" \
          PROVISIONING_PROFILE_SPECIFIER="" \
          ARCHS=arm64 \
          ONLY_ACTIVE_ARCH=NO \
          ENTITLEMENTS_FILE="$ENTITLEMENTS_FULL_PATH"

        # Build the app without code signing for TrollStore
        $BUILD_CMD \
          -scheme ${{ env.SCHEME_NAME }} \
          -configuration $BUILD_CONFIGURATION \
          -destination generic/platform=iOS \
          -archivePath build/DepthCamera-TrollStore.xcarchive \
          archive \
          CODE_SIGN_IDENTITY="" \
          CODE_SIGNING_REQUIRED=NO \
          CODE_SIGNING_ALLOWED=NO \
          DEVELOPMENT_TEAM="" \
          PROVISIONING_PROFILE_SPECIFIER="" \
          ARCHS=arm64 \
          ONLY_ACTIVE_ARCH=NO \
          ENTITLEMENTS_FILE="$ENTITLEMENTS_FULL_PATH" || {
            echo "‚ö†Ô∏è Primary build failed, trying alternative configuration..."

            # Retry with different settings
            $BUILD_CMD \
              -scheme ${{ env.SCHEME_NAME }} \
              -configuration $BUILD_CONFIGURATION \
              -destination generic/platform=iOS \
              -archivePath build/DepthCamera-TrollStore.xcarchive \
              archive \
              CODE_SIGN_IDENTITY="" \
              CODE_SIGNING_REQUIRED=NO \
              CODE_SIGNING_ALLOWED=NO \
              DEVELOPMENT_TEAM="" \
              PROVISIONING_PROFILE_SPECIFIER=""
          }

        echo "‚úÖ Build completed successfully"

    - name: Export Unsigned IPA
      run: |
        echo "üì¶ Exporting unsigned IPA..."

        # Create export options for unsigned IPA
        cat > build/TrollStore-Export.plist << 'EOF'
        <?xml version="1.0" encoding="UTF-8"?>
        <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
        <plist version="1.0">
        <dict>
            <key>method</key>
            <string>development</string>
            <key>signingStyle</key>
            <string>manual</string>
            <key>codeSignIdentity</key>
            <string></string>
            <key>provisioningProfiles</key>
            <dict>
            </dict>
            <key>stripSwiftSymbols</key>
            <false/>
            <key>uploadBitcode</key>
            <false/>
            <key>uploadSymbols</key>
            <false/>
            <key>compileBitcode</key>
            <false/>
            <key>thinning</key>
            <string>&lt;none&gt;</string>
        </dict>
        </plist>
        EOF

        # Export the archive as unsigned IPA
        xcodebuild \
          -exportArchive \
          -archivePath build/DepthCamera-TrollStore.xcarchive \
          -exportPath build/TrollStore-IPA \
          -exportOptionsPlist build/TrollStore-Export.plist \
          -allowProvisioningUpdates || {
            echo "‚ö†Ô∏è Export failed, creating manual IPA..."

            # Create IPA manually if export fails
            echo "üîß Creating IPA manually from archive..."
            cd build

            # Find the .app file
            APP_PATH=$(find DepthCamera-TrollStore.xcarchive -name "*.app" -type d | head -n 1)

            if [ -n "$APP_PATH" ]; then
              echo "‚úÖ Found app at: $APP_PATH"
              echo "App size: $(du -sh "$APP_PATH")"

              # Create Payload directory
              mkdir -p Payload
              cp -r "$APP_PATH" Payload/

              # Create IPA
              zip -r "../DepthCamera-TrollStore-${{ github.run_number }}.ipa" Payload/

              # Clean up
              rm -rf Payload

              echo "‚úÖ Manual IPA created successfully!"
            else
              echo "‚ùå Could not find .app file in archive"
              echo "Archive contents:"
              find DepthCamera-TrollStore.xcarchive -type d
              exit 1
            fi

            cd ..
          }

        echo "‚úÖ Export process completed"

    - name: Create Unsigned IPA Package
      run: |
        cd build

        # Find existing IPA or create from export
        if [ -f "TrollStore-IPA/*.ipa" ]; then
          echo "üì± Found exported IPA"
          cp TrollStore-IPA/*.ipa "../DepthCamera-TrollStore-${{ github.run_number }}.ipa"
        elif [ -f "../DepthCamera-TrollStore-${{ github.run_number }}.ipa" ]; then
          echo "üì± IPA already created manually"
        else
          echo "‚ö†Ô∏è No IPA found, creating from app bundle..."

          # Find the .app file
          APP_PATH=$(find . -name "*.app" -type d | head -n 1)

          if [ -n "$APP_PATH" ]; then
            # Create Payload directory
            mkdir -p Payload
            cp -r "$APP_PATH" Payload/

            # Create IPA
            zip -r "../DepthCamera-TrollStore-${{ github.run_number }}.ipa" Payload/

            # Clean up
            rm -rf Payload
          else
            echo "‚ùå Could not find .app file"
            exit 1
          fi
        fi

        cd ..

    - name: Verify IPA Structure
      run: |
        if [ -f "DepthCamera-TrollStore-${{ github.run_number }}.ipa" ]; then
          echo "‚úÖ IPA file created successfully!"
          echo "üìä File size: $(du -h DepthCamera-TrollStore-${{ github.run_number }}.ipa)"

          # Extract and verify IPA contents
          mkdir -p temp_verify
          cd temp_verify
          unzip -q "../DepthCamera-TrollStore-${{ github.run_number }}.ipa"

          echo "üìÅ IPA Contents:"
          find Payload -name "*.app" -exec ls -la {} \;

          APP_NAME=$(find Payload -name "*.app" -type d -exec basename {} \;)
          if [ -n "$APP_NAME" ]; then
            echo "‚úÖ App bundle verified: $APP_NAME"
          fi

          cd ..
          rm -rf temp_verify
        else
          echo "‚ùå IPA file not found!"
          exit 1
        fi

    - name: Generate Build Information
      run: |
        cat > build-info.json << EOF
        {
          "build_number": "${{ github.run_number }}",
          "commit_sha": "${{ github.sha }}",
          "branch": "${{ github.ref_name }}",
          "build_type": "${{ github.event.inputs.build_type || 'Release' }}",
          "timestamp": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
          "bundle_identifier": "${{ env.BUNDLE_IDENTIFIER }}",
          "marketing_version": "${{ env.MARKETING_VERSION }}",
          "ipa_file": "DepthCamera-TrollStore-${{ github.run_number }}.ipa",
          "trollstore_optimized": true,
          "build_status": "success"
        }
        EOF

        echo "üìã Build information:"
        cat build-info.json

    - name: Upload Unsigned IPA
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: depthcamera-trollstore-ipa
        path: |
          DepthCamera-TrollStore-${{ github.run_number }}.ipa
          build-info.json
        retention-days: 30

    - name: Upload Build Logs
      uses: actions/upload-artifact@v4
      if: failure()
      with:
        name: build-logs-${{ github.run_number }}
        path: |
          build/
          *.log
          *.xcresult
        retention-days: 7

    - name: Create Release (Main Branch Only)
      if: github.ref == 'refs/heads/main' && github.event_name == 'push'
      uses: softprops/action-gh-release@v2
      with:
        name: "TrollStore Build ${{ github.run_number }}"
        body: |
          ## üì± DepthCamera TrollStore Build

          **Build Information:**
          - üè∑Ô∏è **Version:** ${{ env.MARKETING_VERSION }} (${{ github.run_number }})
          - üìÖ **Date:** $(date +'%Y-%m-%d %H:%M UTC')
          - üîó **Commit:** [${{ github.sha }}](${{ github.server_url }}/${{ github.repository }}/commit/${{ github.sha }})

          **Features:**
          - ‚úÖ **TrollStore Optimized** - Ready for TrollStore installation
          - ‚úÖ **Unsigned IPA** - No code signing required
          - ‚úÖ **Enhanced ARKit** - Maximum LiDAR depth capture
          - ‚úÖ **File System Access** - Unrestricted file operations

          **Installation:**
          1. Download the `.ipa` file below
          2. Install via TrollStore on your iOS device
          3. Grant permissions when prompted

          ---
          ‚ö†Ô∏è **TrollStore Only:** This build requires TrollStore and will not work with standard sideloading.
        files: |
          DepthCamera-TrollStore-${{ github.run_number }}.ipa
          build-info.json
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}