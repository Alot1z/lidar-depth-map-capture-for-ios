name: trollstore ipa build

on:
  push:
    branches: [ main, develop, trollstore ]
  pull_request:
    branches: [ main, develop, trollstore ]
  workflow_dispatch:
    inputs:
      build_type:
        description: 'Build type'
        required: true
        default: 'Release'
        type: choice
        options:
        - Debug
        - Release

env:
  BUNDLE_IDENTIFIER: 'dev.iori.depthcamera0'
  MARKETING_VERSION: '1.1'
  SCHEME_NAME: 'DepthCamera'
  PROJECT_DIR: 'lidar-depth-map-capture-for-ios/lidar-depth-map-capture-for-ios'
  WORKSPACE_NAME: 'DepthCamera.xcworkspace'
  PROJECT_NAME: 'DepthCamera.xcodeproj'
  TROLLSTORE_ENTITLEMENTS: 'lidar-depth-map-capture-for-ios/lidar-depth-map-capture-for-ios/DepthCamera/DepthCamera-TrollStore.entitlements'

jobs:
  # Build Unsigned IPA for TrollStore
  build-trollstore:
    runs-on: macos-latest

    steps:
    - name: Checkout Repository
      uses: actions/checkout@v4

    - name: Setup Xcode
      uses: maxim-lobanov/setup-xcode@v1
      with:
        xcode-version: 'latest-stable'

    - name: Setup Ruby
      uses: ruby/setup-ruby@v1
      with:
        ruby-version: '3.2'
        bundler-cache: true

    - name: Cache CocoaPods
      uses: actions/cache@v3
      with:
        path: |
          Pods
          ~/Library/Caches/CocoaPods
          ~/.cocoapods
        key: ${{ runner.os }}-pods-${{ hashFiles('**/Podfile.lock') }}
        restore-keys: |
          ${{ runner.os }}-pods-

    - name: Install CocoaPods Dependencies
      run: |
        echo "üîß Installing CocoaPods dependencies in ${{ env.PROJECT_DIR }}..."
        cd ${{ env.PROJECT_DIR }}
        pod install --repo-update
        echo "‚úÖ CocoaPods installed successfully"

    - name: Verify Project Structure
      run: |
        echo "üîç Verifying project structure..."
        echo "Current directory: $(pwd)"
        echo ""
        echo "Root directory contents:"
        ls -la
        echo ""
        echo "Project directory (${{ env.PROJECT_DIR }}) contents:"
        ls -la ${{ env.PROJECT_DIR }}/
        echo ""
        echo "Looking for workspace:"
        find ${{ env.PROJECT_DIR }} -name "*.xcworkspace" -type d
        echo ""
        echo "Looking for project:"
        find ${{ env.PROJECT_DIR }} -name "*.xcodeproj" -type d
        echo ""
        echo "Looking for TrollStore entitlements:"
        find ${{ env.PROJECT_DIR }} -name "*TrollStore*" -type f

    - name: Check TrollStore Entitlements
      run: |
        ENTITLEMENTS_FULL_PATH="${{ env.TROLLSTORE_ENTITLEMENTS }}"
        if [ -f "$ENTITLEMENTS_FULL_PATH" ]; then
          echo "‚úÖ TrollStore entitlements found at $ENTITLEMENTS_FULL_PATH"
          echo "Entitlements file size: $(wc -c < "$ENTITLEMENTS_FULL_PATH") bytes"
        else
          echo "‚ùå TrollStore entitlements not found at $ENTITLEMENTS_FULL_PATH"
          echo "Searching for entitlements files:"
          find ${{ env.PROJECT_DIR }} -name "*.entitlements" -type f
          echo "Creating fallback entitlements..."
          mkdir -p ${{ env.PROJECT_DIR }}/DepthCamera
          cat > "$ENTITLEMENTS_FULL_PATH" << 'EOF'
        <?xml version="1.0" encoding="UTF-8"?>
        <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
        <plist version="1.0">
        <dict>
            <key>com.apple.developer.team-identifier</key>
            <string>9RWAJP8AG7</string>
            <key>com.apple.security.application-groups</key>
            <array>
                <string>group.dev.iori.depthcamera</string>
            </array>
        </dict>
        </plist>
        EOF
          echo "‚úÖ Fallback entitlements created"
        fi
        echo "ENTITLEMENTS_FULL_PATH=$ENTITLEMENTS_FULL_PATH" >> $GITHUB_ENV

    - name: List Available Schemes
      run: |
        cd ${{ env.PROJECT_DIR }}
        echo "üìã Listing available schemes..."
        if [ -f "DepthCamera.xcworkspace" ]; then
          echo "‚úÖ Using workspace: DepthCamera.xcworkspace"
          xcodebuild -workspace DepthCamera.xcworkspace -list
        elif [ -f "DepthCamera.xcodeproj" ]; then
          echo "‚úÖ Using project: DepthCamera.xcodeproj"
          xcodebuild -project DepthCamera.xcodeproj -list
        else
          echo "‚ùå No Xcode project or workspace found in ${{ env.PROJECT_DIR }}"
          exit 1
        fi

    - name: Configure Build Number
      run: |
        BUILD_NUMBER=${{ github.run_number }}
        echo "üî¢ Setting build number to: $BUILD_NUMBER"

        # Try to set build number if project exists
        if [ -f "${{ env.PROJECT_NAME }}" ]; then
          echo "Setting version info in ${{ env.PROJECT_NAME }}..."
          cd ${{ env.PROJECT_NAME }} 2>/dev/null || cd $(basename "${{ env.PROJECT_NAME }}" .xcodeproj)
          agvtool new-marketing-version ${{ env.MARKETING_VERSION }} || echo "Failed to set marketing version (non-critical)"
          agvtool new-version -all $BUILD_NUMBER || echo "Failed to set build version (non-critical)"
          cd ..
          echo "‚úÖ Build number configured"
        else
          echo "‚ö†Ô∏è Project not found: ${{ env.PROJECT_NAME }}"
        fi

    - name: Build App without Code Signing
      run: |
        # Configuration based on input
        BUILD_CONFIGURATION="${{ github.event.inputs.build_type || 'Release' }}"
        echo "üî® Building configuration: $BUILD_CONFIGURATION"

        # Change to project directory
        cd ${{ env.PROJECT_DIR }}
        echo "üìç Current directory: $(pwd)"
        echo "üìÅ Directory contents:"
        ls -la

        # Find workspace or project
        WORKSPACE_PATH=$(find . -name "*.xcworkspace" -type d | head -n 1)
        PROJECT_PATH=$(find . -name "*.xcodeproj" -type d | head -n 1)

        if [ -n "$WORKSPACE_PATH" ]; then
          echo "üì± Using workspace: $WORKSPACE_PATH"
          WORKSPACE_NAME=$(basename "$WORKSPACE_PATH")
          xcodebuild -workspace "$WORKSPACE_NAME" -list
          BUILD_BASE="xcodebuild -workspace \"$WORKSPACE_NAME\""
        elif [ -n "$PROJECT_PATH" ]; then
          echo "üì± Using project: $PROJECT_PATH"
          PROJECT_NAME=$(basename "$PROJECT_PATH")
          xcodebuild -project "$PROJECT_NAME" -list
          BUILD_BASE="xcodebuild -project \"$PROJECT_NAME\""
        else
          echo "‚ùå No Xcode project or workspace found"
          echo "Available files:"
          find . -name "*.xcworkspace" -o -name "*.xcodeproj"
          exit 1
        fi

        echo "üöÄ Starting TrollStore build process..."

        # Create build directory
        mkdir -p build

        # Build the app without code signing for TrollStore
        $BUILD_BASE \
          -scheme ${{ env.SCHEME_NAME }} \
          -configuration $BUILD_CONFIGURATION \
          -destination generic/platform=iOS \
          -archivePath build/DepthCamera-TrollStore.xcarchive \
          CODE_SIGN_IDENTITY="" \
          CODE_SIGNING_REQUIRED=NO \
          CODE_SIGNING_ALLOWED=NO \
          DEVELOPMENT_TEAM="" \
          PROVISIONING_PROFILE_SPECIFIER="" \
          ARCHS=arm64 \
          ONLY_ACTIVE_ARCH=NO \
          ENABLE_BITCODE=NO \
          GCC_PREPROCESSOR_DEFINITIONS='$(inherited) NDEBUG=1'

        echo "‚úÖ Archive completed successfully"

        # Verify archive was created
        if [ -d "build/DepthCamera-TrollStore.xcarchive" ]; then
          echo "‚úÖ Archive verified at build/DepthCamera-TrollStore.xcarchive"
          echo "üìä Archive size: $(du -sh build/DepthCamera-TrollStore.xcarchive)"
        else
          echo "‚ùå Archive not found!"
          echo "üìÅ Build directory contents:"
          ls -la build/
          exit 1
        fi

    - name: Create Unsigned IPA
      run: |
        echo "üì¶ Creating unsigned IPA from archive..."

        # Change to project directory
        cd ${{ env.PROJECT_DIR }}
        echo "üìç Working directory: $(pwd)"

        # Verify archive exists
        if [ ! -d "build/DepthCamera-TrollStore.xcarchive" ]; then
          echo "‚ùå Archive not found!"
          echo "üìÅ Build directory contents:"
          ls -la build/ || echo "Build directory doesn't exist"
          exit 1
        fi

        # Find the .app file in the archive
        APP_PATH=$(find build/DepthCamera-TrollStore.xcarchive -name "*.app" -type d | head -n 1)

        if [ -z "$APP_PATH" ]; then
          echo "‚ùå No .app file found in archive!"
          echo "üîç Archive structure:"
          find build/DepthCamera-TrollStore.xcarchive -type d | head -20
          echo "üîç All .app files:"
          find build/DepthCamera-TrollStore.xcarchive -name "*.app" -type d
          exit 1
        fi

        echo "‚úÖ Found app at: $APP_PATH"
        echo "üìä App size: $(du -sh "$APP_PATH")"

        # Create IPA manually (more reliable than xcodebuild export)
        cd build

        # Create Payload directory
        mkdir -p Payload

        # Copy the app bundle
        echo "üìã Copying app bundle..."
        cp -r "$APP_PATH" Payload/

        # Verify Payload structure
        echo "üìÅ Payload structure:"
        ls -la Payload/
        if [ -d "Payload/$(basename "$APP_PATH")" ]; then
          echo "‚úÖ App bundle copied successfully"
        else
          echo "‚ùå App bundle copy failed!"
          exit 1
        fi

        # Create the IPA file
        echo "üóúÔ∏è Creating IPA archive..."
        zip -r "../DepthCamera-TrollStore-${{ github.run_number }}.ipa" Payload/

        # Verify IPA was created
        if [ -f "../DepthCamera-TrollStore-${{ github.run_number }}.ipa" ]; then
          echo "‚úÖ IPA created successfully!"
          echo "üìä IPA file: DepthCamera-TrollStore-${{ github.run_number }}.ipa"
          echo "üìä IPA size: $(du -sh "../DepthCamera-TrollStore-${{ github.run_number }}.ipa")"

          # Test IPA integrity
          echo "üîç Testing IPA integrity..."
          if unzip -t "../DepthCamera-TrollStore-${{ github.run_number }}.ipa" > /dev/null 2>&1; then
            echo "‚úÖ IPA integrity check passed"
          else
            echo "‚ö†Ô∏è IPA integrity check failed"
          fi
        else
          echo "‚ùå IPA creation failed!"
          echo "üìÅ Current directory contents:"
          ls -la ..
          exit 1
        fi

        # Clean up
        rm -rf Payload
        cd ..

        echo "üéâ IPA creation completed successfully!"

    
    - name: Verify IPA Structure
      run: |
        if [ -f "DepthCamera-TrollStore-${{ github.run_number }}.ipa" ]; then
          echo "‚úÖ IPA file created successfully!"
          echo "üìä File size: $(du -h DepthCamera-TrollStore-${{ github.run_number }}.ipa)"

          # Extract and verify IPA contents
          mkdir -p temp_verify
          cd temp_verify
          unzip -q "../DepthCamera-TrollStore-${{ github.run_number }}.ipa"

          echo "üìÅ IPA Contents:"
          find Payload -name "*.app" -exec ls -la {} \;

          APP_NAME=$(find Payload -name "*.app" -type d -exec basename {} \;)
          if [ -n "$APP_NAME" ]; then
            echo "‚úÖ App bundle verified: $APP_NAME"
          fi

          cd ..
          rm -rf temp_verify
        else
          echo "‚ùå IPA file not found!"
          exit 1
        fi

    - name: Generate Build Information
      run: |
        echo "üîç Current directory: $(pwd)"
        echo "üîç Looking for IPA file..."
        find . -name "*.ipa" -type f -exec ls -la {} \;

        cat > build-info.json << EOF
        {
          "build_number": "${{ github.run_number }}",
          "commit_sha": "${{ github.sha }}",
          "branch": "${{ github.ref_name }}",
          "build_type": "${{ github.event.inputs.build_type || 'Release' }}",
          "timestamp": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
          "bundle_identifier": "${{ env.BUNDLE_IDENTIFIER }}",
          "marketing_version": "${{ env.MARKETING_VERSION }}",
          "ipa_file": "DepthCamera-TrollStore-${{ github.run_number }}.ipa",
          "trollstore_optimized": true,
          "build_status": "success"
        }
        EOF

        echo "üìã Build information created:"
        ls -la build-info.json
        echo "üìã Build information contents:"
        cat build-info.json

    - name: Upload Unsigned IPA
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: depthcamera-trollstore-ipa
        path: |
          DepthCamera-TrollStore-${{ github.run_number }}.ipa
          build-info.json
        retention-days: 30

    - name: Upload Build Logs
      uses: actions/upload-artifact@v4
      if: failure()
      with:
        name: build-logs-${{ github.run_number }}
        path: |
          build/
          *.log
          *.xcresult
        retention-days: 7

    - name: Create Release (Main Branch Only)
      if: github.ref == 'refs/heads/main' && github.event_name == 'push'
      uses: softprops/action-gh-release@v2
      with:
        name: "TrollStore Build ${{ github.run_number }}"
        body: |
          ## üì± DepthCamera TrollStore Build

          **Build Information:**
          - üè∑Ô∏è **Version:** ${{ env.MARKETING_VERSION }} (${{ github.run_number }})
          - üìÖ **Date:** $(date +'%Y-%m-%d %H:%M UTC')
          - üîó **Commit:** [${{ github.sha }}](${{ github.server_url }}/${{ github.repository }}/commit/${{ github.sha }})

          **Features:**
          - ‚úÖ **TrollStore Optimized** - Ready for TrollStore installation
          - ‚úÖ **Unsigned IPA** - No code signing required
          - ‚úÖ **Enhanced ARKit** - Maximum LiDAR depth capture
          - ‚úÖ **File System Access** - Unrestricted file operations

          **Installation:**
          1. Download the `.ipa` file below
          2. Install via TrollStore on your iOS device
          3. Grant permissions when prompted

          ---
          ‚ö†Ô∏è **TrollStore Only:** This build requires TrollStore and will not work with standard sideloading.
        files: |
          DepthCamera-TrollStore-${{ github.run_number }}.ipa
          build-info.json
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}